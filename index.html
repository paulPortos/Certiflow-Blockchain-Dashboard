<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CertiFlow — Blockchain Explorer</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet" />
</head>

<body>

  <!-- ── TOP NAV ─────────────────────────────────────────────── -->
  <header class="navbar">
    <div class="navbar-brand">
      <div class="brand-icon">⬡</div>
      <span class="brand-name">CertiFlow</span>
      <span class="brand-sub">Blockchain Explorer</span>
    </div>

    <div class="network-status" id="networkStatus">
      <span class="status-dot disconnected" id="statusDot"></span>
      <span id="statusText">Disconnected</span>
    </div>

    <div class="navbar-right">
      <div class="network-info" id="networkInfo" style="display:none">
        <span class="info-chip" id="blockNumber">Block —</span>
        <span class="info-chip" id="networkId">Chain —</span>
      </div>
      <button class="btn btn-primary" id="connectBtn" onclick="connectAndLoad()">
        Connect
      </button>
      <button class="btn btn-ghost btn-sm" onclick="openConfigModal()" title="Reconfigure">Settings</button>
    </div>
  </header>

  <!-- ── SETTINGS DRAWER ────────────────────────────────────── -->
  <div class="settings-bar" id="settingsBar">
    <div class="settings-inner">
      <div class="setting-group">
        <label>RPC URL</label>
        <input type="text" id="rpcUrl" value="http://127.0.0.1:7545" placeholder="http://127.0.0.1:7545" />
      </div>
      <div class="setting-group">
        <label>Certificate Registry</label>
        <input type="text" id="certAddr" placeholder="0x..." />
      </div>
      <div class="setting-group">
        <label>Entity Registry</label>
        <input type="text" id="entityAddr" placeholder="0x..." />
      </div>
      <div class="setting-group">
        <label>Attachment Registry</label>
        <input type="text" id="attachAddr" placeholder="0x..." />
      </div>
      <button class="btn btn-ghost" onclick="toggleSettings()">✕ Close</button>
    </div>
  </div>

  <!-- ── MAIN ───────────────────────────────────────────────── -->
  <main class="main">

    <!-- Disconnected splash -->
    <div class="splash" id="splash">
      <div class="splash-icon">&#x2B21;</div>
      <h1>CertiFlow Blockchain Explorer</h1>
      <p>Inspect every certificate, entity, and attachment stored on-chain.<br />
        Read-only &mdash; no wallet required.</p>
      <div class="splash-actions">
        <button class="btn btn-primary btn-lg" onclick="connectAndLoad()">Connect</button>
        <button class="btn btn-ghost btn-lg" onclick="openConfigModal()">Configure Connection</button>
      </div>
      <div class="splash-chips">
        <span class="splash-chip">Read-only</span>
        <span class="splash-chip">3 Smart Contracts</span>
        <span class="splash-chip">No MetaMask needed</span>
      </div>
    </div>

    <!-- Dashboard content (hidden until connected) -->
    <div id="dashboard" style="display:none">

      <!-- STAT CARDS -->
      <section class="stats-row">
        <div class="stat-card" id="statCert">
          <div class="stat-icon cert-icon"></div>
          <div class="stat-body">
            <div class="stat-value" id="certCount">—</div>
            <div class="stat-label">Certificates</div>
          </div>
          <div class="stat-badge cert-badge">Registry</div>
        </div>
        <div class="stat-card" id="statEntity">
          <div class="stat-icon entity-icon"></div>
          <div class="stat-body">
            <div class="stat-value" id="entityCount">—</div>
            <div class="stat-label">Entities</div>
          </div>
          <div class="stat-badge entity-badge">Registry</div>
        </div>
        <div class="stat-card" id="statAttach">
          <div class="stat-icon attach-icon"></div>
          <div class="stat-body">
            <div class="stat-value" id="attachCount">—</div>
            <div class="stat-label">Attachments</div>
          </div>
          <div class="stat-badge attach-badge">Registry</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"></div>
          <div class="stat-body">
            <div class="stat-value" id="totalTx">—</div>
            <div class="stat-label">Total Events</div>
          </div>
          <div class="stat-badge">On-chain</div>
        </div>
      </section>

      <!-- LOOKUP TOOL -->
      <section class="lookup-section">
        <div class="lookup-card">
          <h3>Hash Lookup</h3>
          <p>Paste any credential hash, entity hash, or file hash to query its on-chain record.</p>
          <div class="lookup-row">
            <select id="lookupRegistry">
              <option value="certificate">Certificate Registry</option>
              <option value="entity">Entity Registry</option>
              <option value="attachment">Attachment Registry</option>
            </select>
            <input type="text" id="lookupHash" placeholder="0x..." spellcheck="false" />
            <button class="btn btn-primary" onclick="lookupHash()">Lookup</button>
          </div>
          <div id="lookupResult"></div>
        </div>
      </section>

      <!-- TABS -->
      <section class="tabs-section">
        <div class="tabs-header">
          <button class="tab-btn active" onclick="switchTab('certificates', this)">
            Certificates
            <span class="tab-count" id="tabCertCount">0</span>
          </button>
          <button class="tab-btn" onclick="switchTab('entities', this)">
            Entities
            <span class="tab-count" id="tabEntityCount">0</span>
          </button>
          <button class="tab-btn" onclick="switchTab('attachments', this)">
            Attachments
            <span class="tab-count" id="tabAttachCount">0</span>
          </button>
          <div class="tabs-spacer"></div>
          <button class="btn btn-ghost btn-sm" onclick="exportToCsv()">Export CSV</button>
          <button class="btn btn-ghost btn-sm" onclick="connectAndLoad()">Refresh</button>
          <button class="btn btn-ghost btn-sm" onclick="toggleSettings()">Settings</button>
        </div>

        <!-- Certificates tab -->
        <div class="tab-panel active" id="tab-certificates">
          <div id="certTableWrap">
            <div class="empty-state">No certificate events found.</div>
          </div>
        </div>

        <!-- Entities tab -->
        <div class="tab-panel" id="tab-entities">
          <div id="entityTableWrap">
            <div class="empty-state">No entity events found.</div>
          </div>
        </div>

        <!-- Attachments tab -->
        <div class="tab-panel" id="tab-attachments">
          <div id="attachTableWrap">
            <div class="empty-state">No attachment events found.</div>
          </div>
        </div>
      </section>

    </div><!-- /dashboard -->

    <!-- ── FAQ SECTION ─────────────────────────────────────── -->
    <section class="faq-section">
      <div class="faq-header">
        <span class="faq-icon"></span>
        <div>
          <h2>How to Connect &amp; Use This Dashboard</h2>
          <p class="faq-subtitle">Everything you need to know to explore CertiFlow's on-chain data.</p>
        </div>
      </div>

      <div class="faq-list">

        <div class="faq-item">
          <button class="faq-question">
            <span>What is this dashboard?</span>
            <span class="faq-arrow">›</span>
          </button>
          <div class="faq-answer">
            <p>This is a <strong>read-only blockchain explorer</strong> for CertiFlow's three smart contracts deployed
              on the <strong>Polygon Amoy testnet</strong>. It lets you inspect every certificate registration, entity
              verification, and file attachment record that has been stored on-chain &mdash; directly from the
              blockchain, with no intermediary server.</p>
          </div>
        </div>

        <div class="faq-item">
          <button class="faq-question">
            <span>Do I need MetaMask, a wallet, or any account?</span>
            <span class="faq-arrow">›</span>
          </button>
          <div class="faq-answer">
            <p><strong>No wallet or account is needed.</strong> This dashboard only <em>reads</em> blockchain data using
              a public RPC endpoint. No transactions are made, no signing is required. Just open the page and click
              <em>Connect</em> &mdash; data loads automatically.
            </p>
          </div>
        </div>

        <div class="faq-item">
          <button class="faq-question">
            <span>How do I see all transactions from the 3 contracts?</span>
            <span class="faq-arrow">›</span>
          </button>
          <div class="faq-answer">
            <p>Click <strong>"Connect"</strong> (or the page auto-connects if config is saved). The dashboard
              immediately fetches all on-chain events from all three registries:<br /><br />
              &nbsp;&nbsp;<strong>Certificates tab</strong> &mdash; all issued, updated, and revoked
              certificates<br />
              &nbsp;&nbsp;<strong>Entities tab</strong> &mdash; all registered organizations and businesses<br />
              &nbsp;&nbsp;<strong>Attachments tab</strong> &mdash; all verified document file hashes<br /><br />
              Click <em>Refresh</em> at any time to reload the latest events from the chain.
            </p>
          </div>
        </div>

        <div class="faq-item">
          <button class="faq-question">
            <span>How do I verify a specific certificate or entity?</span>
            <span class="faq-arrow">›</span>
          </button>
          <div class="faq-answer">
            <p>Use the <strong>Hash Lookup</strong> tool (above the tabs, visible after connecting). Paste any
              <code>0x…</code> hash &mdash; such as a certificate metadata hash, entity hash, or file hash &mdash;
              select the correct registry, and click <strong>Lookup</strong>. The contract returns the full on-chain
              record including timestamp, version, and validity status.
            </p>
          </div>
        </div>

        <div class="faq-item">
          <button class="faq-question">
            <span>Can I use my own RPC or contract addresses (for local dev)?</span>
            <span class="faq-arrow">›</span>
          </button>
          <div class="faq-answer">
            <p>Yes. Click <strong>Configure Connection</strong> (in the navbar) to change the RPC URL
              and contract addresses at any time. For example, to connect to a local Ganache node, set the RPC to
              <code>http://127.0.0.1:7545</code> and paste your locally deployed contract addresses. Your settings are
              saved in the browser and persist across sessions.
            </p>
          </div>
        </div>

        <div class="faq-item">
          <button class="faq-question">
            <span>Where can I verify the contracts on a block explorer?</span>
            <span class="faq-arrow">›</span>
          </button>
          <div class="faq-answer">
            <p>Look up your contract addresses on the relevant block explorer for your network. For example, if you're
              using Polygon Amoy, visit <a href="https://amoy.polygonscan.com" target="_blank"
                rel="noopener">amoy.polygonscan.com</a> and search for your deployed contract addresses.</p>
          </div>
        </div>

        <div class="faq-item">
          <button class="faq-question">
            <span>Is the on-chain data permanent and tamper-proof?</span>
            <span class="faq-arrow">›</span>
          </button>
          <div class="faq-answer">
            <p>Yes. Once a certificate or entity is registered, the record is <strong>immutable</strong> &mdash; it
              cannot be deleted or altered. Even revocations are recorded as permanent on-chain marks (not deletions).
              This is the core security guarantee of the blockchain: data is transparent, auditable, and cannot be
              falsified after the fact.</p>
          </div>
        </div>

      </div><!-- /faq-list -->
    </section><!-- /faq-section -->

  </main>

  <!-- ── CONFIG MODAL ──────────────────────────────────────── -->
  <div class="config-overlay" id="configOverlay">
    <div class="config-modal">
      <div class="config-header">
        <div class="config-icon">&#x2B21;</div>
        <h2>Configure Connection</h2>
        <p>Enter your RPC endpoint and the three contract addresses to get started.</p>
      </div>
      <div class="config-tabs-header">
        <button type="button" class="tab-btn active" id="tabBtnManual" onclick="switchConfigTab('manual')">Manual
          Entry</button>
        <button type="button" class="tab-btn" id="tabBtnPaste" onclick="switchConfigTab('paste')">Quick Paste
          (.env)</button>
      </div>

      <div class="config-body">

        <!-- Manual Entry Tab -->
        <div class="config-tab-panel active" id="cfgPanelManual">
          <div class="config-field">
            <label for="cfgRpc">RPC URL</label>
            <input type="text" id="cfgRpc" placeholder="https://polygon-amoy.g.alchemy.com/v2/YOUR_KEY"
              spellcheck="false" />
          </div>
          <div class="config-field">
            <label for="cfgCert">Certificate Registry Address</label>
            <input type="text" id="cfgCert" placeholder="0x..." spellcheck="false" />
          </div>
          <div class="config-field">
            <label for="cfgEntity">Entity Registry Address</label>
            <input type="text" id="cfgEntity" placeholder="0x..." spellcheck="false" />
          </div>
          <div class="config-field">
            <label for="cfgAttach">Attachment Registry Address</label>
            <input type="text" id="cfgAttach" placeholder="0x..." spellcheck="false" />
          </div>
        </div>

        <!-- Quick Paste Tab -->
        <div class="config-tab-panel" id="cfgPanelPaste">
          <div class="config-field" style="margin-bottom:0">
            <label for="cfgPaste">Paste your keys</label>
            <textarea id="cfgPaste" rows="8"
              placeholder="BLOCKCHAIN_RPC_URL=https://...&#10;CERTIFICATE_REGISTRY_CONTRACT_ADDRESS=0x...&#10;ENTITY_REGISTRY_CONTRACT_ADDRESS=0x...&#10;ATTACHMENT_REGISTRY_CONTRACT_ADDRESS=0x..."
              spellcheck="false" oninput="handleEnvPaste(event)"></textarea>
            <p class="paste-help">Values will be extracted automatically when you paste.</p>
          </div>
        </div>
        <div class="config-actions">
          <button class="btn btn-primary btn-lg config-submit" onclick="submitConfig()">Save & Connect</button>
          <button class="btn btn-ghost btn-sm" onclick="closeConfigModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ── TOAST ─────────────────────────────────────────────── -->
  <div id="toast" class="toast"></div>

  <!-- ── DETAIL MODAL ──────────────────────────────────────── -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="modalTitle">Event Details</h3>
        <button class="modal-close" onclick="closeModal()">✕</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <script src="app.js"></script>
</body>

</html>